<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>utils/actionAssist.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>

    <label for="nav-trigger" class="overlay"></label>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Global</h3>
      <ul>
        <li>
          <a href="global.html#FormatMessageWrapper">FormatMessageWrapper</a>
        </li>
        <li>
          <a href="global.html#InteractionAssemble">InteractionAssemble</a>
        </li>
        <li><a href="global.html#TranslateLocale">TranslateLocale</a></li>
        <li><a href="global.html#actionCore">actionCore</a></li>
        <li><a href="global.html#animalType">animalType</a></li>
        <li><a href="global.html#apiRequest">apiRequest</a></li>
        <li><a href="global.html#apiSuccessCode">apiSuccessCode</a></li>
        <li><a href="global.html#appInitDefault">appInitDefault</a></li>
        <li>
          <a href="global.html#authenticationFailCode"
            >authenticationFailCode</a
          >
        </li>
        <li>
          <a href="global.html#buildRandomHexColor">buildRandomHexColor</a>
        </li>
        <li><a href="global.html#cardConfig">cardConfig</a></li>
        <li><a href="global.html#confirmActionCore">confirmActionCore</a></li>
        <li><a href="global.html#copyToClipboard">copyToClipboard</a></li>
        <li><a href="global.html#destroyMessage">destroyMessage</a></li>
        <li><a href="global.html#emptyLogic">emptyLogic</a></li>
        <li><a href="global.html#emptyLogo">emptyLogo</a></li>
        <li><a href="global.html#extraBuildType">extraBuildType</a></li>
        <li><a href="global.html#filterUpdateModel">filterUpdateModel</a></li>
        <li><a href="global.html#flushLocalStorage">flushLocalStorage</a></li>
        <li>
          <a href="global.html#flushSessionStorage">flushSessionStorage</a>
        </li>
        <li><a href="global.html#formatMessage">formatMessage</a></li>
        <li>
          <a href="global.html#getAuthorityFromRouter"
            >getAuthorityFromRouter</a
          >
        </li>
        <li><a href="global.html#getCorsDomain">getCorsDomain</a></li>
        <li>
          <a href="global.html#getDerivedStateFromPropertiesForUrlParameters"
            >getDerivedStateFromPropertiesForUrlParameters</a
          >
        </li>
        <li>
          <a
            href="global.html#getDerivedStateFromPropertiesForUrlParametersCore"
            >getDerivedStateFromPropertiesForUrlParametersCore</a
          >
        </li>
        <li>
          <a href="global.html#getFromLocalStorage">getFromLocalStorage</a>
        </li>
        <li>
          <a href="global.html#getFromSessionStorage">getFromSessionStorage</a>
        </li>
        <li><a href="global.html#getQueue">getQueue</a></li>
        <li><a href="global.html#getRouteAuthority">getRouteAuthority</a></li>
        <li><a href="global.html#logLevel">logLevel</a></li>
        <li>
          <a href="global.html#mobileTypeCollection">mobileTypeCollection</a>
        </li>
        <li><a href="global.html#modulePackageName">modulePackageName</a></li>
        <li><a href="global.html#notify">notify</a></li>
        <li><a href="global.html#numeralFormat">numeralFormat</a></li>
        <li><a href="global.html#remoteAction">remoteAction</a></li>
        <li><a href="global.html#removeLocalStorage">removeLocalStorage</a></li>
        <li>
          <a href="global.html#removeSessionStorage">removeSessionStorage</a>
        </li>
        <li>
          <a href="global.html#renderFurtherColorWhenNoCallProcess"
            >renderFurtherColorWhenNoCallProcess</a
          >
        </li>
        <li>
          <a href="global.html#renderFurtherPrefixWhenNoCallProcess"
            >renderFurtherPrefixWhenNoCallProcess</a
          >
        </li>
        <li><a href="global.html#saveToLocalStorage">saveToLocalStorage</a></li>
        <li>
          <a href="global.html#saveToSessionStorage">saveToSessionStorage</a>
        </li>
        <li>
          <a href="global.html#setEasySoftUtilityHandler"
            >setEasySoftUtilityHandler</a
          >
        </li>
        <li>
          <a href="global.html#setLocalStorageHandler"
            >setLocalStorageHandler</a
          >
        </li>
        <li>
          <a href="global.html#setMessageDisplayMonitor"
            >setMessageDisplayMonitor</a
          >
        </li>
        <li>
          <a href="global.html#setNavigationHandler">setNavigationHandler</a>
        </li>
        <li>
          <a href="global.html#setNotificationDisplayMonitor"
            >setNotificationDisplayMonitor</a
          >
        </li>
        <li><a href="global.html#setRequestHandler">setRequestHandler</a></li>
        <li>
          <a href="global.html#setSessionStorageHandler"
            >setSessionStorageHandler</a
          >
        </li>
        <li><a href="global.html#shallowUpdateEqual">shallowUpdateEqual</a></li>
        <li><a href="global.html#showInfoMessage">showInfoMessage</a></li>
        <li><a href="global.html#showWarningMessage">showWarningMessage</a></li>
        <li>
          <a href="global.html#unlimitedWithNumberFlag"
            >unlimitedWithNumberFlag</a
          >
        </li>
        <li>
          <a href="global.html#unlimitedWithStringFlag"
            >unlimitedWithStringFlag</a
          >
        </li>
        <li><a href="global.html#whetherList">whetherList</a></li>
      </ul>
    </nav>

    <div id="main">
      <h1 class="page-title">utils/actionAssist.js</h1>

      <section>
        <article>
          <pre
            class="prettyprint source linenums"
          ><code>import { getDispatch } from 'easy-soft-dva';
import {
  buildPromptModuleInfo,
  checkStringIsNullOrWhiteSpace,
  getGuid,
  isArray,
  isFunction,
  isUndefined,
  logException,
  logExecute,
  logTrace,
  mergeArrowText,
  mergeTextMessage,
  showSimpleSuccessNotification,
} from 'easy-soft-utility';

import { destroyMessage, message, modal } from '../components';

import { emptyLogic } from './constants';
import { modulePackageName } from './definition';

/**
 * Module Name.
 * @private
 */
const moduleName = 'actionAssist';

function buildPromptModuleInfoText(text, ancillaryInformation = '') {
  return buildPromptModuleInfo(
    modulePackageName,
    mergeTextMessage(text, ancillaryInformation),
    moduleName,
  );
}

/**
 * remoteAction
 */
function remoteAction({
  api,
  params,
  target,
  handleData,
  failCallback,
  successCallback,
  successMessage,
  successMessageBuilder,
  showProcessing = false,
  loadingKey = '',
  completeProcess = null,
}) {
  logExecute(buildPromptModuleInfoText('remoteAction', `model access: ${api}`));

  const dispatch = getDispatch();

  if ((dispatch || null) == null) {
    throw new Error('remoteAction: dispatch not allow null');
  }

  dispatch({
    type: api,
    payload: params,
  })
    .then((data) => {
      if (showProcessing) {
        setTimeout(() => {
          destroyMessage(loadingKey);
        }, 200);
      }

      const { dataSuccess } = data;

      if (dataSuccess) {
        const {
          list: remoteListData,
          data: remoteData,
          extra: remoteExtraData,
        } = {
          list: [],
          data: null,
          extra: null,
          ...data,
        };

        let messageText = successMessage;

        if (isFunction(successMessageBuilder)) {
          messageText = successMessageBuilder({
            handleData,
            remoteListData: isArray(remoteListData) ? remoteListData : [],
            remoteData: remoteData || null,
            remoteExtraData: remoteExtraData || null,
            remoteOriginal: data,
          });
        }

        if (!checkStringIsNullOrWhiteSpace(messageText)) {
          showSimpleSuccessNotification(messageText);
        }

        if (isFunction(successCallback)) {
          logTrace(
            {
              target,
              params,
              handleData,
              remoteListData: isArray(remoteListData) ? remoteListData : [],
              remoteData: remoteData || null,
              remoteExtraData: remoteExtraData || null,
              remoteOriginal: data,
            },
            buildPromptModuleInfoText(
              'remoteAction',
              mergeArrowText('trigger', 'successCallback'),
            ),
          );

          successCallback({
            target,
            params,
            handleData,
            remoteListData: isArray(remoteListData) ? remoteListData : [],
            remoteData: remoteData || null,
            remoteExtraData: remoteExtraData || null,
            remoteOriginal: data,
          });
        } else {
          logTrace(
            {
              target,
              api,
              params,
              dispatch,
              remoteOriginal: data,
            },
            buildPromptModuleInfoText(
              'remoteAction',
              mergeArrowText('trigger', 'successCallback', emptyLogic),
            ),
          );
        }
      } else {
        if (isFunction(failCallback)) {
          logTrace(
            {
              target,
              params,
              handleData,
              remoteOriginal: data,
              error: null,
            },
            buildPromptModuleInfoText(
              'remoteAction',
              mergeArrowText('trigger', 'failCallback'),
            ),
          );

          failCallback({
            target,
            params,
            handleData,
            remoteOriginal: data,
            error: null,
          });
        } else {
          logTrace(
            {
              target,
              api,
              params,
              dispatch,
              remoteOriginal: data,
            },
            buildPromptModuleInfoText(
              'remoteAction',
              mergeArrowText('trigger', 'failCallback', emptyLogic),
            ),
          );
        }
      }

      if (isFunction(target.stopProcessing)) {
        target.stopProcessing();
      }

      if (isFunction(target.closePreventRender)) {
        target.closePreventRender(true);
      }

      if (isFunction(completeProcess)) {
        logTrace(
          {
            target,
            api,
            params,
            dispatch,
            remoteOriginal: data,
          },
          buildPromptModuleInfoText(
            'remoteAction',
            mergeArrowText('trigger', 'completeProcess'),
          ),
        );

        completeProcess({
          target,
          api,
          params,
          dispatch,
          remoteOriginal: data,
        });
      } else {
        logTrace(
          {
            target,
            api,
            params,
            dispatch,
            remoteOriginal: data,
          },
          buildPromptModuleInfoText(
            'remoteAction',
            mergeArrowText('trigger', 'completeProcess', emptyLogic),
          ),
        );
      }

      return data;
    })
    .catch((error) => {
      const { message } = error;

      if (!isUndefined(message)) {
        logException(message);
      }

      if (showProcessing) {
        setTimeout(() => {
          destroyMessage(loadingKey);
        }, 200);
      }

      if (isFunction(target.stopProcessing)) {
        target.stopProcessing();
      }

      if (isFunction(target.closePreventRender)) {
        target.closePreventRender(true);
      }

      if (isFunction(completeProcess)) {
        logTrace(
          {
            target,
            api,
            params,
            dispatch,
          },
          buildPromptModuleInfoText(
            'remoteAction',
            mergeArrowText('trigger', 'completeProcess'),
          ),
        );

        completeProcess({ target, api, params, dispatch });
      } else {
        logTrace(
          {
            target,
            api,
            params,
            dispatch,
          },
          buildPromptModuleInfoText(
            'remoteAction',
            mergeArrowText('trigger', 'completeProcess', emptyLogic),
          ),
        );
      }
    });
}

/**
 * Remote assess wrapper core.
 * @function
 * @param {Object} option option.
 * @param {string} option.api dva model effect like "modelName/effect".
 * @param {Object} option.params request params.
 * @param {Object} option.target the passed appendage object，eg "component".
 * @param {Object} option.handleData the data will transmit to callback.
 * @param {Function} [option.beforeProcess = null] preprocessing of requests.
 * @param {Number} [option.delay = 400]  delay millisecond before request.
 * @param {Boolean} [option.showProcessing = true] whether show processing prompt.
 * @param {string} [option.processingPrompt = '处理中，请稍后'] prompt text when show processing.
 * @param {string} [option.completeProcess  =null] request complete callback.
 * @param {Function} [option.failCallback = null]  if it is function, it will exec when request fail.
 * @param {Function} [option.successCallback = null] if it is function, it will exec when request success.
 * @param {string} [option.successMessage = '数据已经操作成功，请进行后续操作。'] when request success. if successMessage not null or empty, will notify with this this message.
 * @param {Function} [option.successMessageBuilder=null] success message builder, priority over successMessage, must return string.
 */
export async function actionCore({
  api,
  params,
  handleData,
  target,
  beforeProcess = null,
  delay = 400,
  showProcessing = true,
  processingPrompt = '处理中，请稍后',
  completeProcess = null,
  failCallback = null,
  successCallback = null,
  successMessage = '数据已经操作成功，请进行后续操作。',
  successMessageBuilder = null,
}) {
  logExecute(buildPromptModuleInfoText('actionCore', `api:"${api}"`));

  if ((target || null) == null) {
    throw new Error('actionCore: target not allow null');
  }

  if ((target.props || null) == null) {
    throw new Error('actionCore: target.props not allow null');
  }

  let key = '';

  if (showProcessing) {
    logTrace(
      buildPromptModuleInfoText(
        'actionCore',
        mergeArrowText(`api:"${api}"`, 'showProcessing', true),
      ),
    );

    key = getGuid();

    message.loading({
      key,
      content: checkStringIsNullOrWhiteSpace(processingPrompt)
        ? '处理中，请稍后'
        : processingPrompt,
      duration: 0,
    });
  }

  if (isFunction(beforeProcess)) {
    beforeProcess({ target, params });
  }

  if (isFunction(target.openPreventRender)) {
    target.openPreventRender();
  }

  if (isFunction(target.startProcessing)) {
    target.startProcessing();
  }

  if (delay &lt;= 0) {
    remoteAction({
      api,
      params,
      handleData,
      target,
      failCallback,
      successCallback,
      successMessage,
      successMessageBuilder,
      showProcessing,
      loadingKey: key,
      completeProcess,
    });
  } else {
    setTimeout(() => {
      // 延迟一定时间，优化界面呈现
      remoteAction({
        api,
        params,
        handleData,
        target,
        failCallback,
        successMessage,
        successMessageBuilder,
        showProcessing,
        loadingKey: key,
        successCallback,
        completeProcess,
      });
    }, delay);
  }
}

/**
 * api request.
 * @function
 * @param {Object} option request option.
 * @param {string} option.api dva model effect like "modelName/effect".
 * @param {Object} option.params request params.
 * @param {Function} [option.beforeProcess = null] preprocessing of requests.
 * @param {Function} [option.failCallback = null]  if it is function, it will exec when request fail.
 * @param {Function} [option.successCallback = null] if it is function, it will exec when request success.
 * @param {string} [option.successMessage = ''] when request success. if successMessage not null or empty, will notify with this this message.
 * @param {Function} [option.successMessageBuilder = null] success message builder, priority over successMessage, must return string.
 * @param {Boolean} [option.showProcessing = false] whether show processing prompt.
 * @param {string} [option.processingPrompt = ''] prompt text when show processing.
 * @param {Object} [option.completeProcess = null] request complete callback.
 */
export function apiRequest({
  api,
  params,
  beforeProcess = null,
  failCallback = null,
  successCallback = null,
  successMessage = '',
  successMessageBuilder = null,
  showProcessing = false,
  processingPrompt = '',
  completeProcess = null,
}) {
  logExecute(buildPromptModuleInfoText('apiRequest', `model access: ${api}`));

  const dispatch = getDispatch();

  let parametersAdjust = {};

  if (isFunction(beforeProcess)) {
    parametersAdjust = beforeProcess({ api, dispatch, params }) || params;
  }

  let key = '';

  if (showProcessing) {
    logTrace(
      buildPromptModuleInfoText(
        'apiRequest',
        mergeArrowText('showProcessing', true),
      ),
    );

    key = getGuid();

    message.loading({
      key,
      content: checkStringIsNullOrWhiteSpace(processingPrompt)
        ? '处理中，请稍后'
        : processingPrompt,
      duration: 0,
    });
  }

  dispatch({
    type: api,
    payload: parametersAdjust,
  })
    .then((data) => {
      if (showProcessing) {
        setTimeout(() => {
          destroyMessage(key);
        }, 200);
      }

      const { dataSuccess } = {
        dataSuccess: false,
        ...data,
      };

      if (dataSuccess) {
        const {
          list: remoteListData,
          data: remoteData,
          extra: remoteExtraData,
        } = {
          list: [],
          data: null,
          extra: null,
          ...data,
        };

        let messageText = successMessage;

        if (isFunction(successMessageBuilder)) {
          logTrace(
            {
              api,
              params,
              dispatch,
              remoteOriginal: data,
              error: null,
            },
            buildPromptModuleInfoText(
              'apiRequest',
              mergeArrowText('trigger', 'successMessageBuilder'),
            ),
          );

          messageText = successMessageBuilder({
            remoteListData: isArray(remoteListData) ? remoteListData : [],
            remoteData: remoteData || null,
            remoteExtraData: remoteExtraData || null,
            remoteOriginal: data,
          });
        }

        if (!checkStringIsNullOrWhiteSpace(messageText)) {
          showSimpleSuccessNotification(messageText);
        }

        if (isFunction(successCallback)) {
          logTrace(
            {
              api,
              params,
              dispatch,
              remoteListData: isArray(remoteListData) ? remoteListData : [],
              remoteData: remoteData || null,
              remoteExtraData: remoteExtraData || null,
              remoteOriginal: data,
            },
            buildPromptModuleInfoText(
              'apiRequest',
              mergeArrowText('trigger', 'successCallback'),
            ),
          );

          successCallback({
            api,
            params,
            dispatch,
            remoteListData: isArray(remoteListData) ? remoteListData : [],
            remoteData: remoteData || null,
            remoteExtraData: remoteExtraData || null,
            remoteOriginal: data,
          });
        } else {
          logTrace(
            {
              api,
              params,
              dispatch,
              remoteListData: isArray(remoteListData) ? remoteListData : [],
              remoteData: remoteData || null,
              remoteExtraData: remoteExtraData || null,
              remoteOriginal: data,
            },
            buildPromptModuleInfoText(
              'apiRequest',
              mergeArrowText('trigger', 'successCallback', emptyLogic),
            ),
          );
        }
      } else {
        if (isFunction(failCallback)) {
          logTrace(
            {
              api,
              params,
              dispatch,
              remoteOriginal: data,
              error: null,
            },
            buildPromptModuleInfoText(
              'apiRequest',
              mergeArrowText('trigger', 'failCallback'),
            ),
          );

          failCallback({
            api,
            params,
            dispatch,
            remoteOriginal: data,
            error: null,
          });
        } else {
          logTrace(
            {
              api,
              params,
              dispatch,
              remoteOriginal: data,
              error: null,
            },
            buildPromptModuleInfoText(
              'apiRequest',
              mergeArrowText('trigger', 'failCallback', emptyLogic),
            ),
          );
        }
      }

      if (isFunction(completeProcess)) {
        logTrace(
          {
            api,
            params,
            dispatch,
            remoteOriginal: data,
          },
          buildPromptModuleInfoText(
            'apiRequest',
            mergeArrowText('trigger', 'completeProcess'),
          ),
        );

        completeProcess({
          api,
          params,
          dispatch,
          remoteOriginal: data,
        });
      } else {
        logTrace(
          {
            api,
            params,
            dispatch,
            remoteOriginal: data,
          },
          buildPromptModuleInfoText(
            'apiRequest',
            mergeArrowText('trigger', 'completeProcess', emptyLogic),
          ),
        );
      }

      return data;
    })
    .catch((error) => {
      const { message } = error;

      if (!isUndefined(message)) {
        logException(message);
      }

      if (showProcessing) {
        setTimeout(() => {
          destroyMessage(key);
        }, 200);
      }

      if (isFunction(completeProcess)) {
        logTrace(
          {
            api,
            params,
            dispatch,
          },
          buildPromptModuleInfoText(
            'apiRequest',
            mergeArrowText('trigger', 'completeProcess'),
          ),
        );

        completeProcess({ api, params, dispatch });
      } else {
        logTrace(
          {
            api,
            params,
            dispatch,
          },
          buildPromptModuleInfoText(
            'apiRequest',
            mergeArrowText('trigger', 'completeProcess', emptyLogic),
          ),
        );
      }
    });
}

/**
 * Confirm with remote assess wrapper core.
 * @function
 * @param {Object} option option.
 * @param {string} option.api dva model effect like "modelName/effect".
 * @param {Object} option.params request params.
 * @param {Object} option.target the passed appendage object，eg "component".
 * @param {Object} option.title title.
 * @param {Object} option.content content.
 * @param {Object} [option.okText='确定'] ok button text, default value is '确定'.
 * @param {Object} [option.okType='primary'] ok button type, default value is 'danger'.
 * @param {Object} [option.cancelText='取消'] cancel button text, default value is '取消'.
 * @param {Boolean} [option.showProcessing=true] whether show processing prompt.
 * @param {string} [option.processingPrompt='处理中，请稍后'] prompt text when show processing.
 * @param {Function} [option.beforeProcess=null] preprocessing of requests.
 * @param {Function} [option.failCallback=null]  if it is function, it will exec when request fail.
 * @param {Function} [option.successCallback=null] if it is function, it will exec when request success.
 * @param {string} [option.completeProcess=null] request complete callback.
 * @param {string} [option.successMessage='数据已经操作成功，请进行后续操作。'] when request success. if successMessage not null or empty, will notify with this this message.
 * @param {Function} [option.successMessageBuilder=null] success message builder, priority over successMessage, must return string.
 */
export async function confirmActionCore({
  api,
  params,
  handleData,
  target,
  title,
  content,
  okText = '确定',
  okType = 'primary',
  cancelText = '取消',
  showProcessing = true,
  processingPrompt = '处理中，请稍后',
  beforeProcess = null,
  completeProcess = null,
  failCallback = null,
  successCallback = null,
  successMessage = '数据已经操作成功，请进行后续操作。',
  successMessageBuilder = null,
}) {
  logExecute('confirmActionCore');

  modal.confirm({
    title: title || '',
    content: content || '',
    okText: okText || '确定',
    okType: okType || 'primary',
    cancelText: cancelText || '取消',
    onOk: () => {
      setTimeout(() => {
        actionCore({
          api,
          params,
          handleData,
          target,
          failCallback,
          successCallback,
          successMessage,
          successMessageBuilder,
          showProcessing,
          processingPrompt,
          delay: 0,
          beforeProcess,
          completeProcess,
        });
      }, 300);
    },
    onCancel() {},
  });
}
</code></pre>
        </article>
      </section>
    </div>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Mon Jun 03
      2024 17:31:00 GMT+0800 (中国标准时间) using the
      <a href="https://github.com/clenemt/docdash">docdash</a> theme.
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/polyfill.js"></script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
